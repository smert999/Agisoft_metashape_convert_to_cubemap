# Конвертер сферических изображений в кубическую проекцию для Agisoft Metashape

Этот скрипт `convert_to_cubemap_v007.py` предназначен для преобразования сферических (360°) изображений в кубическую проекцию (six-faced cube map) в среде Agisoft Metashape. Скрипт автоматически создает шесть перспективных изображений для каждой сферической панорамы и соответствующие камеры в проекте.

## Особенности

- Преобразование сферических изображений в шесть граней кубической проекции
- Автоматическое определение системы координат проекта (Y-UP, Z-UP, X-UP)
- Многопоточная обработка для ускорения конвертации
- Настраиваемое перекрытие между гранями куба для лучшей стыковки
- Проверка качества стыковки граней куба
- Сохранение внутренней и внешней ориентации камер

## Системные требования

- Agisoft Metashape Professional (рекомендуется версия 1.8 или выше)
- Python 3.x (входит в комплект Metashape)
- OpenCV (устанавливается автоматически скриптом при необходимости)

## Установка

1. Скачайте файл `convert_to_cubemap_v007.py`
2. Поместите файл в удобное для вас место (например, в папку со скриптами Metashape)

## Использование

### Подготовка проекта

1. Перед запуском скрипта необходимо добавить сферические изображения в проект Metashape и правильно определить их положение в пространстве (выровнять).
2. Сферические изображения должны быть в эквидистантной проекции (equirectangular).

### Запуск скрипта

1. В Metashape выберите меню **Инструменты > Запустить скрипт...**
2. В появившемся диалоговом окне найдите и выберите файл `convert_to_cubemap_v007.py`
3. Нажмите кнопку "Открыть", чтобы запустить скрипт
4. В появившемся диалоговом окне выберите папку для сохранения созданных изображений граней куба
5. Введите значение перекрытия между гранями (рекомендуется 10° для надежной стыковки)

Альтернативно можно запустить скрипт через консоль Python в Metashape:
1. Откройте **Инструменты > Консоль**  
2. Введите команду:
   ```python
   exec(open("/путь/к/файлу/convert_to_cubemap_v007.py").read())
   ```

### Параметры работы

- **Выходная папка**: Директория, в которую будут сохранены изображения граней куба.
- **Перекрытие (overlap)**: Значение перекрытия между гранями в градусах (от 0 до 20). Рекомендуемое значение: 10°.

## Принцип работы

1. Скрипт анализирует координатную систему проекта для правильной ориентации граней куба.
2. Для каждой сферической камеры создается шесть перспективных изображений (front, right, left, top, down, back).
3. Создаются новые камеры в проекте с правильной позицией и ориентацией.
4. Изображения граней сохраняются в указанную папку с именами: `[имя_исходной_камеры]_[грань].jpg`.

## Результаты

После выполнения скрипта в проект будут добавлены новые камеры для каждой грани куба. Их можно использовать для:

- Создания плотного облака точек
- Построения текстурированной модели
- Улучшения качества выравнивания при работе со сферическими панорамами

## Советы по использованию

- Убедитесь, что сферические изображения имеют достаточное разрешение для получения качественных граней куба.
- Если в вашем проекте используются камеры разного типа, рекомендуется отключить все несферические камеры перед запуском скрипта.
- Проверьте результаты конвертации, особенно при использовании нестандартных систем координат.
- Для больших проектов процесс конвертации может занять значительное время.

## Устранение проблем

- Если скрипт не может определить систему координат, попробуйте выбрать её вручную, изменив значение переменной `coord_system` в коде.
- При проблемах с установкой OpenCV выполните установку вручную:
  ```
  /путь/к/python_metashape/python.exe -m pip install opencv-python
  ```
- При ошибках стыковки граней куба попробуйте увеличить значение перекрытия (overlap).
